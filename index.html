<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #quiz-container { margin-top: 20px; }
        .question { margin-bottom: 20px; }
        button { margin-top: 10px; }
        .draggable { cursor: move; padding: 5px; margin: 5px; background-color: #f0f0f0; display: inline-block; }
        .droppable { min-height: 30px; min-width: 100px; border: 1px dashed #999; padding: 5px; margin: 5px; }
        .droppable:empty::before { content: 'Drop here'; color: #999; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        td { text-align: center; }
        .category { margin-top: 10px; border: 1px solid #ccc; padding: 10px; }
        .category-title { font-weight: bold; margin-bottom: 5px; }
        .category-items { min-height: 50px; }
        .draggable-container { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-bottom: 10px; 
        }
        .draggable { 
            cursor: move; 
            padding: 5px; 
            margin: 5px; 
            background-color: #f0f0f0; 
            display: inline-block; 
            border: 1px solid #999;
        }
        .droppable { 
            min-height: 30px; 
            border: 1px dashed #999; 
            padding: 5px; 
            margin: 5px; 
            background-color: #f9f9f9;
        }
        .droppable-placeholder {
            color: #999;
            text-align: center;
        }
        .draggable-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .draggable, .dropped-item {
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: move;
        }
        .category {
            margin-bottom: 15px;
        }
        .category-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .category-items {
            min-height: 50px;
            border: 2px dashed #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .draggable-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .draggable {
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            cursor: move;
        }
        .drop-zone {
            width: 150px;
            height: 50px;
            border: 2px dashed #ccc;
            margin: 10px 0;
        }
        .drag-over {
            border-color: #000;
        }
        .hide {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Quiz App</h1>
    <div id="quiz-container"></div>
    <button id="submit-btn" style="display: none;">Submit</button>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        let currentQuestionIndex = 0;
        let questions = [];
        let score = 0;

        // 배열을 무작위로 섞는 함수
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 문제를 섞는 함수
        function shuffleQuestions() {
            questions = shuffleArray(questions);
        }

        // 보기를 섞는 함수
        function shuffleOptions(question) {
            if (question.options) {
                const shuffledOptions = shuffleArray([...question.options]);
                // 정답의 인덱스를 업데이트
                if (Array.isArray(question.answer)) {
                    question.answer = question.answer.map(ans => 
                        shuffledOptions[question.options.indexOf(ans)]
                    );
                } else if (typeof question.answer === 'string') {
                    question.answer = shuffledOptions[question.options.indexOf(question.answer)];
                }
                question.options = shuffledOptions;
            }
            return question;
        }

        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                questions = await response.json();
                if (!Array.isArray(questions) || questions.length === 0) {
                    throw new Error('문제 데이터가 올바르지 않습니다.');
                }
                displayQuestion();
            } catch (error) {
                console.error('문제를 불러오는 데 실패했습니다:', error);
                document.getElementById('quiz-container').innerHTML = '<p>문제를 불러오는 데 실패했습니다.</p>';
            }
        }

        function displayQuestion() {
            const quizContainer = document.getElementById('quiz-container');
            if (!questions || questions.length === 0 || currentQuestionIndex >= questions.length) {
                quizContainer.innerHTML = '<p>문제를 불러오는 데 실패했습니다.</p>';
                return;
            }

            const question = questions[currentQuestionIndex];
            let html = `<h2>${question.question}</h2>`;

            if (question.type === 'category_drag_drop') {
                html += createCategoryDragDropHtml(question);
            } else if (question.type === 'drag_drop') {
                html += createDragDropHtml(question);
            } else if (question.type === 'grid_multiple_items') {
                html += createGridMultipleItemsHtml(question);
            } else {
                html += createMultipleChoiceHtml(question);
            }

            quizContainer.innerHTML = html;

            if (question.type === 'category_drag_drop' || question.type === 'drag_drop') {
                setupDragAndDrop(question.type);
            }

            // Submit 버튼 표시
            document.getElementById('submit-btn').style.display = 'block';
        }

        function setupDragAndDrop(type) {
            const optionsContainer = document.getElementById('options');
            const items = optionsContainer.querySelectorAll('.draggable');
            
            items.forEach(item => {
                item.addEventListener('dragstart', dragStart);
                item.addEventListener('dragend', dragEnd);
            });

            if (type === 'category_drag_drop') {
                const categories = document.querySelectorAll('.category-items');
                categories.forEach(category => {
                    category.addEventListener('dragover', dragOver);
                    category.addEventListener('dragenter', dragEnter);
                    category.addEventListener('dragleave', dragLeave);
                    category.addEventListener('drop', drop);
                });
            } else if (type === 'drag_drop') {
                const dropZones = document.querySelectorAll('.drop-zone');
                dropZones.forEach(zone => {
                    zone.addEventListener('dragover', dragOver);
                    zone.addEventListener('dragenter', dragEnter);
                    zone.addEventListener('dragleave', dragLeave);
                    zone.addEventListener('drop', drop);
                });
            }
        }

        function checkAnswer() {
            const question = questions[currentQuestionIndex];
            let isCorrect = false;

            try {
                if (question.type === 'category_drag_drop') {
                    isCorrect = checkCategoryDragDrop(question);
                } else if (question.type === 'drag_drop') {
                    isCorrect = checkDragDrop(question);
                } else if (question.type === 'grid_multiple_items') {
                    isCorrect = checkGridMultipleItems(question);
                } else {
                    isCorrect = checkSingleMultipleChoice(question);
                }
            } catch (error) {
                console.error(`Error checking answer for question ${currentQuestionIndex}:`, error);
                console.error('Question data:', JSON.stringify(question, null, 2));
            }

            return isCorrect;
        }

        function checkCategoryDragDrop(question) {
            if (!question.categories || !question.correct_answers || typeof question.correct_answers !== 'object') {
                console.error('드래그 앤 드롭 문제의 데이터가 올바르지 않습니다.');
                return false;
            }

            let isCorrect = true;
            question.categories.forEach((category, index) => {
                const categoryItems = Array.from(document.querySelectorAll(`.category-items[data-category="${index}"] > div`))
                                           .map(item => item.textContent.trim());
                const correctAnswers = question.correct_answers[category];
                if (!Array.isArray(correctAnswers)) {
                    console.error(`${category}에 대한 올바른 답변이 배열이 아닙니다.`);
                    isCorrect = false;
                    return;
                }
                if (JSON.stringify(categoryItems.sort()) !== JSON.stringify(correctAnswers.sort())) {
                    isCorrect = false;
                }
            });
            return isCorrect;
        }

        function checkDragDrop(question) {
            const dropZones = document.querySelectorAll('.drop-zone');
            const userAnswer = Array.from(dropZones).map(zone => {
                const draggable = zone.firstElementChild;
                return draggable ? draggable.textContent : null;
            }).filter(answer => answer !== null);

            if (Array.isArray(question.answer)) {
                return JSON.stringify(userAnswer) === JSON.stringify(question.answer);
            } else {
                return userAnswer.length === 1 && userAnswer[0] === question.answer;
            }
        }

        function checkGridMultipleItems(question) {
            if (!question.column_headers || !question.row_headers || !question.correct_answers || typeof question.correct_answers !== 'object') {
                console.error('그리드 다중 항목 문제의 데이터가 올바르지 않습니다.');
                return false;
            }

            let isCorrect = true;
            question.column_headers.forEach((colHeader, colIndex) => {
                const correctAnswers = question.correct_answers[colHeader];
                if (!Array.isArray(correctAnswers)) {
                    console.error(`${colHeader}에 대한 올바른 답변이 배열이 아닙니다.`);
                    isCorrect = false;
                    return;
                }
                question.row_headers.forEach((rowHeader, rowIndex) => {
                    const checkbox = document.querySelector(`input[name="grid-${rowIndex}-${colIndex}"]`);
                    if (checkbox && checkbox.checked !== correctAnswers.includes(rowHeader)) {
                        isCorrect = false;
                    }
                });
            });
            return isCorrect;
        }

        function checkSingleMultipleChoice(question) {
            const selectedOption = document.querySelector('input[name="quiz"]:checked');
            if (!selectedOption) return false;
            return question.answer.includes(question.options[selectedOption.value]);
        }

        document.getElementById('submit-btn').addEventListener('click', () => {
            if (!questions || currentQuestionIndex >= questions.length) {
                console.error('유효하지 않은 문제 상태');
                return;
            }

            if (checkAnswer()) {
                score++;
            }
            currentQuestionIndex++;

            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                showFinalScore();
            }
        });

        function showFinalScore() {
            const quizContainer = document.getElementById('quiz-container');
            const submitBtn = document.getElementById('submit-btn');
            
            quizContainer.innerHTML = `<h2>퀴즈 완료!</h2>
                                       <p>당신의 점수: ${score} / ${questions.length}</p>`;
            submitBtn.style.display = 'none';
        }

        function showError(message) {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `<h2>오류</h2><p>${message}</p>`;
        }

        // 페이지 로드 시 질문을 불러옵니다
        window.onload = loadQuestions;

        // 퀴즈 시작 시 문제 섞기
        function startQuiz() {
            shuffleQuestions();
            currentQuestionIndex = 0;
            score = 0;
            displayQuestion();
        }

        function createCategoryDragDropHtml(question) {
            let html = '<div id="options" class="draggable-container">';
            question.options.forEach(option => {
                html += `<div class="draggable" draggable="true">${option}</div>`;
            });
            html += '</div><div id="categories-container">';
            question.categories.forEach((category, index) => {
                html += `
                    <div class="category">
                        <div class="category-title">${category}</div>
                        <div class="category-items droppable" data-category="${index}"></div>
                    </div>`;
            });
            html += '</div>';
            return html;
        }

        function createDragDropHtml(question) {
            let html = '<div id="options" class="draggable-container">';
            question.options.forEach((option, index) => {
                html += `<div id="draggable-${index}" class="draggable" draggable="true">${option}</div>`;
            });
            html += '</div><div id="answer-container">';
            
            // answers 배열의 길이만큼 드롭 영역 생성
            const answerCount = Array.isArray(question.answer) ? question.answer.length : 1;
            for (let i = 0; i < answerCount; i++) {
                html += `<div class="drop-zone" data-index="${i}"></div>`;
            }
            html += '</div>';
            return html;
        }

        function createGridMultipleItemsHtml(question) {
            let html = '<table><tr><th></th>';
            question.column_headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr>';
            question.row_headers.forEach((rowHeader, rowIndex) => {
                html += `<tr><td>${rowHeader}</td>`;
                question.column_headers.forEach((colHeader, colIndex) => {
                    html += `<td><input type="checkbox" name="grid-${rowIndex}-${colIndex}"></td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            return html;
        }

        function createMultipleChoiceHtml(question) {
            let html = '';
            if (Array.isArray(question.options)) {
                question.options.forEach((option, index) => {
                    html += `<label>
                        <input type="radio" name="quiz" value="${index}">
                        ${option}
                    </label><br>`;
                });
            } else {
                html += '<p>이 문제에 대한 옵션이 없습니다.</p>';
            }
            return html;
        }

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.id);
            setTimeout(() => e.target.classList.add('hide'), 0);
        }

        function dragEnd(e) {
            e.target.classList.remove('hide');
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function dragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function dragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function drop(e) {
            e.target.classList.remove('drag-over');

            const id = e.dataTransfer.getData('text/plain');
            const draggable = document.getElementById(id);

            e.target.appendChild(draggable);

            draggable.classList.remove('hide');
        }
    </script>
</body>
</html>
