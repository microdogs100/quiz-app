<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #quiz-container { margin-top: 20px; }
        .question { margin-bottom: 20px; }
        button { margin-top: 10px; }
        .draggable { cursor: move; padding: 5px; margin: 5px; background-color: #f0f0f0; display: inline-block; }
        .droppable { min-height: 30px; min-width: 100px; border: 1px dashed #999; padding: 5px; margin: 5px; }
        .droppable:empty::before { content: 'Drop here'; color: #999; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        td { text-align: center; }
        .category { margin-top: 10px; border: 1px solid #ccc; padding: 10px; }
        .category-title { font-weight: bold; margin-bottom: 5px; }
        .category-items { min-height: 50px; }
        .draggable-container { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-bottom: 10px; 
        }
        .draggable { 
            cursor: move; 
            padding: 5px; 
            margin: 5px; 
            background-color: #f0f0f0; 
            display: inline-block; 
            border: 1px solid #999;
        }
        .droppable { 
            min-height: 30px; 
            border: 1px dashed #999; 
            padding: 5px; 
            margin: 5px; 
            background-color: #f9f9f9;
        }
        .droppable-placeholder {
            color: #999;
            text-align: center;
        }
        .draggable-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .draggable, .dropped-item {
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: move;
        }
        .category {
            margin-bottom: 15px;
        }
        .category-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .category-items {
            min-height: 50px;
            border: 2px dashed #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Quiz App</h1>
    <div id="quiz-container"></div>
    <button id="submit-btn" style="display: none;">Submit</button>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        let currentQuestionIndex = 0;
        let questions = [];
        let score = 0;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                questions = await response.json();
                if (!Array.isArray(questions) || questions.length === 0) {
                    throw new Error('문제 데이터가 올바르지 않습니다.');
                }
                displayQuestion();
            } catch (error) {
                console.error('문제를 불러오는 데 실패했습니다:', error);
                document.getElementById('quiz-container').innerHTML = '<p>문제를 불러오는 데 실패했습니다.</p>';
            }
        }

        function displayQuestion() {
            const quizContainer = document.getElementById('quiz-container');
            if (!questions || questions.length === 0 || currentQuestionIndex >= questions.length) {
                quizContainer.innerHTML = '<p>문제를 불러오는 데 실패했습니다.</p>';
                return;
            }

            const question = questions[currentQuestionIndex];
            let html = `<h2>${question.question}</h2>`;

            if (question.type === 'category_drag_drop') {
                html += '<div id="options" class="draggable-container">';
                shuffleArray(question.options); // 옵션 순서를 섞습니다
                question.options.forEach(option => {
                    html += `<div class="draggable" draggable="true">${option}</div>`;
                });
                html += '</div>';
                question.categories.forEach((category, index) => {
                    html += `<div class="category">
                        <div class="category-title">${category}</div>
                        <div class="category-items droppable" data-category="${index}"></div>
                    </div>`;
                });
            } else if (question.type === 'grid_multiple_items') {
                html += '<table><tr><th></th>';
                question.column_headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr>';
                question.row_headers.forEach((rowHeader, rowIndex) => {
                    html += `<tr><th>${rowHeader}</th>`;
                    question.column_headers.forEach((_, colIndex) => {
                        html += `<td>
                            <input type="checkbox" 
                                   name="q${currentQuestionIndex}r${rowIndex}c${colIndex}" 
                                   id="q${currentQuestionIndex}r${rowIndex}c${colIndex}">
                        </td>`;
                    });
                    html += '</tr>';
                });
                html += '</table>';
            } else {
                const inputType = (question.type === 'multiple_choice' || Array.isArray(question.answer)) ? 'checkbox' : 'radio';
                let options = [...question.options];
                shuffleArray(options); // 보기 순서 섞기
                options.forEach((option, index) => {
                    html += `<div>
                        <input type="${inputType}" 
                               name="q${currentQuestionIndex}" 
                               value="${option}" 
                               id="q${currentQuestionIndex}o${index}">
                        <label for="q${currentQuestionIndex}o${index}">${option}</label>
                    </div>`;
                });
            }
            
            quizContainer.innerHTML = html;
            
            if (question.type === 'category_drag_drop') {
                setupDragAndDrop();
            }

            // Submit 버튼 표시
            document.getElementById('submit-btn').style.display = 'block';
        }

        function setupDragAndDrop() {
            const optionsContainer = document.getElementById('options');
            new Sortable(optionsContainer, {
                group: {
                    name: 'shared',
                    pull: 'clone',
                    put: false
                },
                animation: 150,
                sort: false
            });

            const categoryContainers = document.querySelectorAll('.category-items');
            categoryContainers.forEach(container => {
                new Sortable(container, {
                    group: 'shared',
                    animation: 150,
                    onAdd: function (evt) {
                        evt.item.classList.add('dropped-item');
                    }
                });
            });
        }

        function checkAnswer() {
            console.log("Checking answer for question:", currentQuestionIndex);
            const question = questions[currentQuestionIndex];
            let isCorrect = false;

            if (question.type === 'category_drag_drop') {
                isCorrect = checkCategoryDragDrop(question);
            } else if (question.type === 'grid_multiple_items') {
                isCorrect = checkGridMultipleItems(question);
            } else {
                isCorrect = checkSingleMultipleChoice(question);
            }

            console.log("Is answer correct?", isCorrect);
            return isCorrect;
        }

        function checkCategoryDragDrop(question) {
            let isCorrect = true;
            question.categories.forEach((category, index) => {
                const categoryItems = Array.from(document.querySelectorAll(`.category-items[data-category="${index}"] > div`))
                                           .map(item => item.textContent.trim());
                const correctAnswers = question.correct_answers[category];
                if (JSON.stringify(categoryItems.sort()) !== JSON.stringify(correctAnswers.sort())) {
                    isCorrect = false;
                }
            });
            return isCorrect;
        }

        function checkGridMultipleItems(question) {
            let isCorrect = true;
            for (let col in question.correct_answers) {
                const correctAnswers = question.correct_answers[col];
                const userAnswers = question.row_headers.filter((_, rowIndex) => 
                    document.getElementById(`q${currentQuestionIndex}r${rowIndex}c${question.column_headers.indexOf(col)}`).checked
                );
                if (JSON.stringify(correctAnswers.sort()) !== JSON.stringify(userAnswers.sort())) {
                    isCorrect = false;
                    break;
                }
            }
            return isCorrect;
        }

        function checkSingleMultipleChoice(question) {
            const selectedOptions = Array.from(document.querySelectorAll(`input[name="q${currentQuestionIndex}"]:checked`))
                                         .map(input => input.value);
            if (Array.isArray(question.answer)) {
                return JSON.stringify(selectedOptions.sort()) === JSON.stringify(question.answer.sort());
            } else {
                return selectedOptions.length === 1 && selectedOptions[0] === question.answer;
            }
        }

        document.getElementById('submit-btn').addEventListener('click', () => {
            if (!questions || currentQuestionIndex >= questions.length) {
                console.error('유효하지 않은 문제 상태');
                return;
            }

            if (checkAnswer()) {
                score++;
            }
            currentQuestionIndex++;

            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                showFinalScore();
            }
        });

        function showFinalScore() {
            const quizContainer = document.getElementById('quiz-container');
            const submitBtn = document.getElementById('submit-btn');
            
            quizContainer.innerHTML = `<h2>퀴즈 완료!</h2>
                                       <p>당신의 점수: ${score} / ${questions.length}</p>`;
            submitBtn.style.display = 'none';
        }

        function showError(message) {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `<h2>오류</h2><p>${message}</p>`;
        }

        // 페이지 로드 시 질문을 불러옵니다
        window.onload = loadQuestions;
    </script>
</body>
</html>
